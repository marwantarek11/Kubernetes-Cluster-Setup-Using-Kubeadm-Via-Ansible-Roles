# Kubernetes Cluster Setup Using Ansible

This repository contains an Ansible playbook and associated roles for setting up a Kubernetes cluster using `kubeadm`. It includes configuration for a master node, worker nodes, and the installation of the Calico network plugin.

## Overview

This project provides a comprehensive approach to deploying a Kubernetes cluster on Ubuntu-based nodes using Ansible. It covers:

- Setting up a Kubernetes master node
- Joining worker nodes to the cluster
- Installing and configuring the Calico network plugin

## Prerequisites

- Ansible 2.9 or later
- Ubuntu 22.04 or later on all nodes
- Basic knowledge of Kubernetes and Ansible
- SSH access to all nodes

## Project Structure

```bash
├── ansible.cfg
├── inventory-Debian
├── inventory-RedHat
├── master.yml
├── playbooks
├── roles
│   ├── common
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
│   ├── containerd
│   │   ├── tasks
│   │   │   └── main.yml
│   │   ├── templates
│   │   │   └── config.toml.j2
│   │   └── vars
│   │       └── main.yml
│   ├── kubernetes
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
│   ├── master
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
│   └── worker
│       ├── tasks
│       │   └── main.yml
│       └── vars
│           └── main.yml
├── site.yml
├── test.pem
└── workers.yml
```

## Installation

1. **Clone the Repository:**

   ```bash
   git clone https://github.com/marwantarek11/Kubernetes-Cluster-Setup-Using-Kubeadm-Via-Ansible-Roles.git
   cd kubernetes-cluster-setup
   ```

2. **Configure Your Inventory:**

   Edit the `inventory` file to include the IP addresses or hostnames of your master and worker nodes.

3. **Set Variables:**

   Update the `vars/main.yml` file with your desired configuration, such as the pod network CIDR and Calico version.

   ```yaml
   kubernetes_version: "1.30.0"
   ubuntu_codename: "{{ ansible_distribution_release | lower }}"
   calico_version: "v3.28.0"
   pod_network_cidr: "10.244.0.0/16"

   ```

4. **Run the Playbook:**

   Execute the playbook to set up your Kubernetes cluster:

   ```bash
   ansible-playbook -i inventory playbook.yml
   ```

## Playbook Breakdown

- **`common` Role:** 
  - Update and upgrade APT packages
  - Disable swap
  - Load kernel modules
  - Load overlay module
  - Load br_netfilter module
  - Set kernel parameters for Kubernetes
  - Apply sysctl parameters
  - Install dependencies
  - Add Docker GPG key
  - Add Docker repository
  - Install containerd
  - Configure containerd
  - Set value of SystemdCgroup
  - Restart and enable containerd
  - Add Kubernetes GPG key
  - Add Kubernetes repository
  - Install Kubernetes components
  - Hold Kubernetes components

- **`master` Role:**
  - Initializes the Kubernetes master node
  - Configures the `kubeconfig` file
  - Installs and configures Calico network plugin
  - Generates and stores the `kubeadm` join command

- **`worker` Role:**
  - Joins worker nodes to the Kubernetes cluster using the join command generated by the master node

## Troubleshooting

- **Common Issues:**
  - If you encounter issues with IP addresses, ensure that `hostname -I` returns the correct IP and check the `master_ip` variable.
  - For issues with Calico installation, verify the version and compatibility with your Kubernetes version.

- **Logs:**
  - Review the Ansible output logs for detailed error messages and stack traces.

## Verify Kubernetes Cluster & Ansible PlayBook

- PlayBook Verification
  
   ![image](https://github.com/user-attachments/assets/2109590e-136d-46f2-8034-09b8f9da2edd)

- Cluster Verification
  
   ![image](https://github.com/user-attachments/assets/e5690057-dcf5-419d-b4e8-41aa545498ad)

